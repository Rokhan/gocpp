// generated by GoCpp from file '$(ImportDir)/runtime/mpallocbits.go'
#include <complex>
#include <functional>
#include <iostream>
#include <iomanip>
#include <map>
#include <string>
#include <tuple>
#include <vector>

#include "golang/runtime/mpallocbits.h"
#include "gocpp/support.h"

#include "golang/runtime/internal/sys/intrinsics.h"
#include "golang/runtime/mpagealloc.h"

namespace golang::runtime
{
    namespace rec
    {
        using namespace mocklib::rec;
    }

    unsigned int rec::get(golang::runtime::pageBits* b, unsigned int i)
    {
        return (unsigned int)((b[i / 64] >> (i % 64)) & 1);
    }

    uint64_t rec::block64(golang::runtime::pageBits* b, unsigned int i)
    {
        return b[i / 64];
    }

    void rec::set(golang::runtime::pageBits* b, unsigned int i)
    {
        b[i / 64] |= 1 << (i % 64);
    }

    void rec::setRange(golang::runtime::pageBits* b, unsigned int i, unsigned int n)
    {
        _ = b[i / 64];
        if(n == 1)
        {
            rec::set(gocpp::recv(b), i);
            return;
        }
        auto j = i + n - 1;
        if(i / 64 == j / 64)
        {
            b[i / 64] |= ((uint64_t(1) << n) - 1) << (i % 64);
            return;
        }
        _ = b[j / 64];
        b[i / 64] |= ~ uint64_t(0) << (i % 64);
        for(auto k = i / 64 + 1; k < j / 64; k++)
        {
            b[k] = ~ uint64_t(0);
        }
        b[j / 64] |= (uint64_t(1) << (j % 64 + 1)) - 1;
    }

    void rec::setAll(golang::runtime::pageBits* b)
    {
        for(auto [i, gocpp_ignored] : b)
        {
            b[i] = ~ uint64_t(0);
        }
    }

    void rec::setBlock64(golang::runtime::pageBits* b, unsigned int i, uint64_t v)
    {
        b[i / 64] |= v;
    }

    void rec::clear(golang::runtime::pageBits* b, unsigned int i)
    {
        b[i / 64] &^= 1 << (i % 64);
    }

    void rec::clearRange(golang::runtime::pageBits* b, unsigned int i, unsigned int n)
    {
        _ = b[i / 64];
        if(n == 1)
        {
            rec::clear(gocpp::recv(b), i);
            return;
        }
        auto j = i + n - 1;
        if(i / 64 == j / 64)
        {
            b[i / 64] &^= ((uint64_t(1) << n) - 1) << (i % 64);
            return;
        }
        _ = b[j / 64];
        b[i / 64] &^= ~ uint64_t(0) << (i % 64);
        for(auto k = i / 64 + 1; k < j / 64; k++)
        {
            b[k] = 0;
        }
        b[j / 64] &^= (uint64_t(1) << (j % 64 + 1)) - 1;
    }

    void rec::clearAll(golang::runtime::pageBits* b)
    {
        for(auto [i, gocpp_ignored] : b)
        {
            b[i] = 0;
        }
    }

    void rec::clearBlock64(golang::runtime::pageBits* b, unsigned int i, uint64_t v)
    {
        b[i / 64] &^= v;
    }

    unsigned int rec::popcntRange(golang::runtime::pageBits* b, unsigned int i, unsigned int n)
    {
        unsigned int s;
        if(n == 1)
        {
            unsigned int s;
            return (unsigned int)((b[i / 64] >> (i % 64)) & 1);
        }
        _ = b[i / 64];
        auto j = i + n - 1;
        if(i / 64 == j / 64)
        {
            unsigned int s;
            return (unsigned int)(sys::OnesCount64((b[i / 64] >> (i % 64)) & ((1 << n) - 1)));
        }
        _ = b[j / 64];
        s += (unsigned int)(sys::OnesCount64(b[i / 64] >> (i % 64)));
        for(auto k = i / 64 + 1; k < j / 64; k++)
        {
            unsigned int s;
            s += (unsigned int)(sys::OnesCount64(b[k]));
        }
        s += (unsigned int)(sys::OnesCount64(b[j / 64] & ((1 << (j % 64 + 1)) - 1)));
        return s;
    }

    runtime::pallocSum rec::summarize(golang::runtime::pallocBits* b)
    {
        unsigned int start = {};
        unsigned int most = {};
        unsigned int cur = {};
        auto notSetYet = ~ (unsigned int)(0);
        start = notSetYet;
        for(auto i = 0; i < len(b); i++)
        {
            auto x = b[i];
            if(x == 0)
            {
                cur += 64;
                continue;
            }
            auto t = (unsigned int)(sys::TrailingZeros64(x));
            auto l = (unsigned int)(sys::LeadingZeros64(x));
            cur += t;
            if(start == notSetYet)
            {
                start = cur;
            }
            most = gocpp::max(most, cur);
            cur = l;
        }
        if(start == notSetYet)
        {
            auto n = (unsigned int)(64 * len(b));
            return packPallocSum(n, n, n);
        }
        most = gocpp::max(most, cur);
        if(most >= 64 - 2)
        {
            return packPallocSum(start, most, cur);
        }
        outer:
        for(auto i = 0; i < len(b); i++)
        {
            auto x = b[i];
            x >>= sys::TrailingZeros64(x) & 63;
            if(x & (x + 1) == 0)
            {
                continue;
            }
            auto p = most;
            auto k = (unsigned int)(1);
            for(; ; )
            {
                for(; p > 0; )
                {
                    if(p <= k)
                    {
                        x |= x >> (p & 63);
                        if(x & (x + 1) == 0)
                        {
                            goto outer_continue;
                        }
                        break;
                    }
                    x |= x >> (k & 63);
                    if(x & (x + 1) == 0)
                    {
                        goto outer_continue;
                    }
                    p -= k;
                    k *= 2;
                }
                auto j = (unsigned int)(sys::TrailingZeros64(~ x));
                x >>= j & 63;
                j = (unsigned int)(sys::TrailingZeros64(x));
                x >>= j & 63;
                most += j;
                if(x & (x + 1) == 0)
                {
                    goto outer_continue;
                }
                p = j;
            }
            if(false) {
            outer_continue:
                continue;
            outer_break:
                break;
            }
        }
        return packPallocSum(start, most, cur);
    }

    std::tuple<unsigned int, unsigned int> rec::find(golang::runtime::pallocBits* b, uintptr_t npages, unsigned int searchIdx)
    {
        if(npages == 1)
        {
            auto addr = rec::find1(gocpp::recv(b), searchIdx);
            return {addr, addr};
        }
        else
        if(npages <= 64)
        {
            return rec::findSmallN(gocpp::recv(b), npages, searchIdx);
        }
        return rec::findLargeN(gocpp::recv(b), npages, searchIdx);
    }

    unsigned int rec::find1(golang::runtime::pallocBits* b, unsigned int searchIdx)
    {
        _ = b[0];
        for(auto i = searchIdx / 64; i < (unsigned int)(len(b)); i++)
        {
            auto x = b[i];
            if(~ x == 0)
            {
                continue;
            }
            return i * 64 + (unsigned int)(sys::TrailingZeros64(~ x));
        }
        return ~ (unsigned int)(0);
    }

    std::tuple<unsigned int, unsigned int> rec::findSmallN(golang::runtime::pallocBits* b, uintptr_t npages, unsigned int searchIdx)
    {
        auto [end, newSearchIdx] = std::tuple{(unsigned int)(0), ~ (unsigned int)(0)};
        for(auto i = searchIdx / 64; i < (unsigned int)(len(b)); i++)
        {
            auto bi = b[i];
            if(~ bi == 0)
            {
                end = 0;
                continue;
            }
            if(newSearchIdx == ~ (unsigned int)(0))
            {
                newSearchIdx = i * 64 + (unsigned int)(sys::TrailingZeros64(~ bi));
            }
            auto start = (unsigned int)(sys::TrailingZeros64(bi));
            if(end + start >= (unsigned int)(npages))
            {
                return {i * 64 - end, newSearchIdx};
            }
            auto j = findBitRange64(~ bi, (unsigned int)(npages));
            if(j < 64)
            {
                return {i * 64 + j, newSearchIdx};
            }
            end = (unsigned int)(sys::LeadingZeros64(bi));
        }
        return {~ (unsigned int)(0), newSearchIdx};
    }

    std::tuple<unsigned int, unsigned int> rec::findLargeN(golang::runtime::pallocBits* b, uintptr_t npages, unsigned int searchIdx)
    {
        auto [start, size, newSearchIdx] = std::tuple{~ (unsigned int)(0), (unsigned int)(0), ~ (unsigned int)(0)};
        for(auto i = searchIdx / 64; i < (unsigned int)(len(b)); i++)
        {
            auto x = b[i];
            if(x == ~ uint64_t(0))
            {
                size = 0;
                continue;
            }
            if(newSearchIdx == ~ (unsigned int)(0))
            {
                newSearchIdx = i * 64 + (unsigned int)(sys::TrailingZeros64(~ x));
            }
            if(size == 0)
            {
                size = (unsigned int)(sys::LeadingZeros64(x));
                start = i * 64 + 64 - size;
                continue;
            }
            auto s = (unsigned int)(sys::TrailingZeros64(x));
            if(s + size >= (unsigned int)(npages))
            {
                size += s;
                return {start, newSearchIdx};
            }
            if(s < 64)
            {
                size = (unsigned int)(sys::LeadingZeros64(x));
                start = i * 64 + 64 - size;
                continue;
            }
            size += 64;
        }
        if(size < (unsigned int)(npages))
        {
            return {~ (unsigned int)(0), newSearchIdx};
        }
        return {start, newSearchIdx};
    }

    void rec::allocRange(golang::runtime::pallocBits* b, unsigned int i, unsigned int n)
    {
        rec::setRange(gocpp::recv((runtime::pageBits*)(b)), i, n);
    }

    void rec::allocAll(golang::runtime::pallocBits* b)
    {
        rec::setAll(gocpp::recv((runtime::pageBits*)(b)));
    }

    void rec::free1(golang::runtime::pallocBits* b, unsigned int i)
    {
        rec::clear(gocpp::recv((runtime::pageBits*)(b)), i);
    }

    void rec::free(golang::runtime::pallocBits* b, unsigned int i, unsigned int n)
    {
        rec::clearRange(gocpp::recv((runtime::pageBits*)(b)), i, n);
    }

    void rec::freeAll(golang::runtime::pallocBits* b)
    {
        rec::clearAll(gocpp::recv((runtime::pageBits*)(b)));
    }

    uint64_t rec::pages64(golang::runtime::pallocBits* b, unsigned int i)
    {
        return rec::block64(gocpp::recv((runtime::pageBits*)(b)), i);
    }

    void rec::allocPages64(golang::runtime::pallocBits* b, unsigned int i, uint64_t alloc)
    {
        rec::setBlock64(gocpp::recv((runtime::pageBits*)(b)), i, alloc);
    }

    unsigned int findBitRange64(uint64_t c, unsigned int n)
    {
        auto p = n - 1;
        auto k = (unsigned int)(1);
        for(; p > 0; )
        {
            if(p <= k)
            {
                c &= c >> (p & 63);
                break;
            }
            c &= c >> (k & 63);
            if(c == 0)
            {
                return 64;
            }
            p -= k;
            k *= 2;
        }
        return (unsigned int)(sys::TrailingZeros64(c));
    }

    
    template<typename T> requires gocpp::GoStruct<T>
    pallocData::operator T()
    {
        T result;
        result.scavenged = this->scavenged;
        return result;
    }

    template<typename T> requires gocpp::GoStruct<T>
    bool pallocData::operator==(const T& ref) const
    {
        if (scavenged != ref.scavenged) return false;
        return true;
    }

    std::ostream& pallocData::PrintTo(std::ostream& os) const
    {
        os << '{';
        os << "" << scavenged;
        os << '}';
        return os;
    }

    std::ostream& operator<<(std::ostream& os, const struct pallocData& value)
    {
        return value.PrintTo(os);
    }

    void rec::allocRange(struct pallocData* m, unsigned int i, unsigned int n)
    {
        rec::allocRange(gocpp::recv(m->pallocBits), i, n);
        rec::clearRange(gocpp::recv(m->scavenged), i, n);
    }

    void rec::allocAll(struct pallocData* m)
    {
        rec::allocAll(gocpp::recv(m->pallocBits));
        rec::clearAll(gocpp::recv(m->scavenged));
    }

}

