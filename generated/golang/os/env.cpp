// generated by GoCpp from file '$(ImportDir)/os/env.go'
#include <complex>
#include <functional>
#include <iostream>
#include <iomanip>
#include <map>
#include <string>
#include <tuple>
#include <vector>

#include "golang/os/env.h"
#include "gocpp/support.h"

#include "golang/internal/testlog/log.h"
#include "golang/os/error.h"
#include "golang/syscall/env_windows.h"

namespace golang::os
{
    namespace rec
    {
        using namespace mocklib::rec;
    }

    // Expand replaces ${var} or $var in the string based on the mapping function.
    // For example, os.ExpandEnv(s) is equivalent to os.Expand(s, os.Getenv).
    std::string Expand(std::string s, std::function<std::string (std::string _1)> mapping)
    {
        gocpp::slice<unsigned char> buf = {};
        auto i = 0;
        for(auto j = 0; j < len(s); j++)
        {
            if(s[j] == '$' && j + 1 < len(s))
            {
                if(buf == nullptr)
                {
                    buf = gocpp::make(gocpp::Tag<gocpp::slice<unsigned char>>(), 0, 2 * len(s));
                }
                buf = append(buf, s.make_slice(i, j));
                auto [name, w] = getShellName(s.make_slice(j + 1));
                if(name == ""s && w > 0)
                {
                }
                else
                if(name == ""s)
                {
                    buf = append(buf, s[j]);
                }
                else
                {
                    buf = append(buf, mapping(name));
                }
                j += w;
                i = j + 1;
            }
        }
        if(buf == nullptr)
        {
            return s;
        }
        return std::string(buf) + s.make_slice(i);
    }

    // ExpandEnv replaces ${var} or $var in the string according to the values
    // of the current environment variables. References to undefined
    // variables are replaced by the empty string.
    std::string ExpandEnv(std::string s)
    {
        return Expand(s, Getenv);
    }

    // isShellSpecialVar reports whether the character identifies a special
    // shell variable such as $*.
    bool isShellSpecialVar(uint8_t c)
    {
        //Go switch emulation
        {
            auto condition = c;
            int conditionId = -1;
            if(condition == '*') { conditionId = 0; }
            else if(condition == '#') { conditionId = 1; }
            else if(condition == '$') { conditionId = 2; }
            else if(condition == '@') { conditionId = 3; }
            else if(condition == '!') { conditionId = 4; }
            else if(condition == '?') { conditionId = 5; }
            else if(condition == '-') { conditionId = 6; }
            else if(condition == '0') { conditionId = 7; }
            else if(condition == '1') { conditionId = 8; }
            else if(condition == '2') { conditionId = 9; }
            else if(condition == '3') { conditionId = 10; }
            else if(condition == '4') { conditionId = 11; }
            else if(condition == '5') { conditionId = 12; }
            else if(condition == '6') { conditionId = 13; }
            else if(condition == '7') { conditionId = 14; }
            else if(condition == '8') { conditionId = 15; }
            else if(condition == '9') { conditionId = 16; }
            switch(conditionId)
            {
                case 0:
                case 1:
                case 2:
                case 3:
                case 4:
                case 5:
                case 6:
                case 7:
                case 8:
                case 9:
                case 10:
                case 11:
                case 12:
                case 13:
                case 14:
                case 15:
                case 16:
                    return true;
                    break;
            }
        }
        return false;
    }

    // isAlphaNum reports whether the byte is an ASCII letter, number, or underscore.
    bool isAlphaNum(uint8_t c)
    {
        return c == '_' || '0' <= c && c <= '9' || 'a' <= c && c <= 'z' || 'A' <= c && c <= 'Z';
    }

    // getShellName returns the name that begins the string and the number of bytes
    // consumed to extract it. If the name is enclosed in {}, it's part of a ${}
    // expansion and two more bytes are needed than the length of the name.
    std::tuple<std::string, int> getShellName(std::string s)
    {
        //Go switch emulation
        {
            int conditionId = -1;
            if(s[0] == '{') { conditionId = 0; }
            else if(isShellSpecialVar(s[0])) { conditionId = 1; }
            switch(conditionId)
            {
                case 0:
                    if(len(s) > 2 && isShellSpecialVar(s[1]) && s[2] == '}')
                    {
                        return {s.make_slice(1, 2), 3};
                    }
                    for(auto i = 1; i < len(s); i++)
                    {
                        if(s[i] == '}')
                        {
                            if(i == 1)
                            {
                                return {""s, 2};
                            }
                            return {s.make_slice(1, i), i + 1};
                        }
                    }
                    return {""s, 1};
                    break;
                case 1:
                    return {s.make_slice(0, 1), 1};
                    break;
            }
        }
        // Scan alphanumerics.
        int i = {};
        for(i = 0; i < len(s) && isAlphaNum(s[i]); i++)
        {
        }
        return {s.make_slice(0, i), i};
    }

    // Getenv retrieves the value of the environment variable named by the key.
    // It returns the value, which will be empty if the variable is not present.
    // To distinguish between an empty value and an unset value, use LookupEnv.
    std::string Getenv(std::string key)
    {
        testlog::Getenv(key);
        auto [v, gocpp_id_1] = syscall::Getenv(key);
        return v;
    }

    // LookupEnv retrieves the value of the environment variable named
    // by the key. If the variable is present in the environment the
    // value (which may be empty) is returned and the boolean is true.
    // Otherwise the returned value will be empty and the boolean will
    // be false.
    std::tuple<std::string, bool> LookupEnv(std::string key)
    {
        testlog::Getenv(key);
        return syscall::Getenv(key);
    }

    // Setenv sets the value of the environment variable named by the key.
    // It returns an error, if any.
    struct gocpp::error Setenv(std::string key, std::string value)
    {
        auto err = syscall::Setenv(key, value);
        if(err != nullptr)
        {
            return NewSyscallError("setenv"s, err);
        }
        return nullptr;
    }

    // Unsetenv unsets a single environment variable.
    struct gocpp::error Unsetenv(std::string key)
    {
        return syscall::Unsetenv(key);
    }

    // Clearenv deletes all environment variables.
    void Clearenv()
    {
        syscall::Clearenv();
    }

    // Environ returns a copy of strings representing the environment,
    // in the form "key=value".
    gocpp::slice<std::string> Environ()
    {
        return syscall::Environ();
    }

}

