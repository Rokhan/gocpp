// generated by GoCpp from file '$(ImportDir)/runtime/print.go'
#include <complex>
#include <functional>
#include <iostream>
#include <iomanip>
#include <map>
#include <string>
#include <tuple>
#include <vector>

#include "golang/runtime/print.h"
#include "gocpp/support.h"

#include "golang/runtime/internal/atomic/types.h"
// #include "golang/runtime/symtab.h"  [Ignored, known errors]
#include "golang/runtime/lock_sema.h"
// #include "golang/internal/goarch/goarch.h"  [Ignored, known errors]
#include "golang/runtime/runtime2.h"
#include "golang/runtime/string.h"
#include "golang/unsafe/unsafe.h"
// #include "golang/runtime/stubs.h"  [Ignored, known errors]
#include "golang/runtime/write_err.h"
#include "golang/runtime/slice.h"

namespace golang::runtime
{
    // using hex = uint64_t;
    gocpp::slice<unsigned char> bytes(std::string s)
    {
        gocpp::slice<unsigned char> ret;
        auto rp = (*slice)(Pointer(gocpp::recv(unsafe), & ret));
        auto sp = stringStructOf(& s);
        rp->array = sp->str;
        rp->len = sp->len;
        rp->cap = sp->len;
        return ret;
    }

    gocpp::array<unsigned char, 512> printBacklog;
    int printBacklogIndex;
    void recordForPanic(gocpp::slice<unsigned char> b)
    {
        printlock();
        if(Load(gocpp::recv(panicking)) == 0)
        {
            for(auto i = 0; i < len(b); )
            {
                auto n = copy(printBacklog.make_slice(printBacklogIndex), b.make_slice(i));
                i += n;
                printBacklogIndex += n;
                printBacklogIndex %= len(printBacklog);
            }
        }
        printunlock();
    }

    mutex debuglock;
    void printlock()
    {
        auto mp = getg()->m;
        mp->locks++;
        mp->printlock++;
        if(mp->printlock == 1)
        {
            lock(& debuglock);
        }
        mp->locks--;
    }

    void printunlock()
    {
        auto mp = getg()->m;
        mp->printlock--;
        if(mp->printlock == 0)
        {
            unlock(& debuglock);
        }
    }

    void gwrite(gocpp::slice<unsigned char> b)
    {
        if(len(b) == 0)
        {
            return;
        }
        recordForPanic(b);
        auto gp = getg();
        if(gp == nullptr || gp->writebuf == nullptr || gp->m->dying > 0)
        {
            writeErr(b);
            return;
        }
        auto n = copy(gp->writebuf.make_slice(len(gp->writebuf), cap(gp->writebuf)), b);
        gp->writebuf = gp->writebuf.make_slice(0, len(gp->writebuf) + n);
    }

    void printsp()
    {
        printstring(" ");
    }

    void printnl()
    {
        printstring("\n");
    }

    void printbool(bool v)
    {
        if(v)
        {
            printstring("true");
        }
        else
        {
            printstring("false");
        }
    }

    void printfloat(double v)
    {
        //Go switch emulation
        {
            int conditionId = -1;
            if(v != v) { conditionId = 0; }
            else if(v + v == v && v > 0) { conditionId = 1; }
            else if(v + v == v && v < 0) { conditionId = 2; }
            switch(conditionId)
            {
                case 0:
                    printstring("NaN");
                    return;
                    break;
                case 1:
                    printstring("+Inf");
                    return;
                    break;
                case 2:
                    printstring("-Inf");
                    return;
                    break;
            }
        }
        auto n = 7;
        gocpp::array<unsigned char, n + 7> buf = {};
        buf[0] = '+';
        auto e = 0;
        if(v == 0)
        {
            if(1 / v < 0)
            {
                buf[0] = '-';
            }
        }
        else
        {
            if(v < 0)
            {
                v = - v;
                buf[0] = '-';
            }
            for(; v >= 10; )
            {
                e++;
                v /= 10;
            }
            for(; v < 1; )
            {
                e--;
                v *= 10;
            }
            auto h = 5.0;
            for(auto i = 0; i < n; i++)
            {
                h /= 10;
            }
            v += h;
            if(v >= 10)
            {
                e++;
                v /= 10;
            }
        }
        for(auto i = 0; i < n; i++)
        {
            auto s = int(v);
            buf[i + 2] = byte(s + '0');
            v -= double(s);
            v *= 10;
        }
        buf[1] = buf[2];
        buf[2] = '.';
        buf[n + 2] = 'e';
        buf[n + 3] = '+';
        if(e < 0)
        {
            e = - e;
            buf[n + 3] = '-';
        }
        buf[n + 4] = byte(e / 100) + '0';
        buf[n + 5] = byte(e / 10) % 10 + '0';
        buf[n + 6] = byte(e % 10) + '0';
        gwrite(buf.make_slice(0, ));
    }

    void printcomplex(gocpp::complex128 c)
    {
        print("(", real(c), imag(c), "i)");
    }

    void printuint(uint64_t v)
    {
        gocpp::array<unsigned char, 100> buf = {};
        auto i = len(buf);
        for(i--; i > 0; i--)
        {
            buf[i] = byte(v % 10 + '0');
            if(v < 10)
            {
                break;
            }
            v /= 10;
        }
        gwrite(buf.make_slice(i));
    }

    void printint(int64_t v)
    {
        if(v < 0)
        {
            printstring("-");
            v = - v;
        }
        printuint(uint64_t(v));
    }

    int minhexdigits = 0;
    void printhex(uint64_t v)
    {
        auto dig = "0123456789abcdef";
        gocpp::array<unsigned char, 100> buf = {};
        auto i = len(buf);
        for(i--; i > 0; i--)
        {
            buf[i] = dig[v % 16];
            if(v < 16 && len(buf) - i >= minhexdigits)
            {
                break;
            }
            v /= 16;
        }
        i--;
        buf[i] = 'x';
        i--;
        buf[i] = '0';
        gwrite(buf.make_slice(i));
    }

    void printpointer(unsafe::Pointer p)
    {
        printhex(uint64_t(uintptr(p)));
    }

    void printuintptr(uintptr_t p)
    {
        printhex(uint64_t(p));
    }

    void printstring(std::string s)
    {
        gwrite(bytes(s));
    }

    void printslice(gocpp::slice<unsigned char> s)
    {
        auto sp = (*slice)(Pointer(gocpp::recv(unsafe), & s));
        print("[", len(s), "/", cap(s), "]");
        printpointer(sp->array);
    }

    void printeface(eface e)
    {
        print("(", e._type, ",", e.data, ")");
    }

    void printiface(iface i)
    {
        print("(", i.tab, ",", i.data, ")");
    }

    void hexdumpWords(uintptr_t p, uintptr_t end, std::function<unsigned char (uintptr_t)> mark)
    {
        printlock();
        gocpp::array<unsigned char, 1> markbuf = {};
        markbuf[0] = ' ';
        minhexdigits = int(Sizeof(gocpp::recv(unsafe), uintptr(0)) * 2);
        for(auto i = uintptr(0); p + i < end; i += goarch.PtrSize)
        {
            if(i % 16 == 0)
            {
                if(i != 0)
                {
                    println();
                }
                print(hex(p + i), ": ");
            }
            if(mark != nullptr)
            {
                markbuf[0] = mark(p + i);
                if(markbuf[0] == 0)
                {
                    markbuf[0] = ' ';
                }
            }
            gwrite(markbuf.make_slice(0, ));
            auto val = *(*uintptr)(Pointer(gocpp::recv(unsafe), p + i));
            print(hex(val));
            print(" ");
            auto fn = findfunc(val);
            if(valid(gocpp::recv(fn)))
            {
                print("<", funcname(fn), "+", hex(val - entry(gocpp::recv(fn))), "> ");
            }
        }
        minhexdigits = 0;
        println();
        printunlock();
    }

}

