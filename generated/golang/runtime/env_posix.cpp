// generated by GoCpp from file '$(ImportDir)/runtime/env_posix.go'
#include <complex>
#include <functional>
#include <iostream>
#include <iomanip>
#include <map>
#include <string>
#include <tuple>
#include <vector>

#include "golang/runtime/env_posix.h"
#include "gocpp/support.h"

#include "golang/runtime/extern.h"
#include "golang/runtime/panic.h"
#include "golang/runtime/runtime1.h"
#include "golang/runtime/stubs.h"
#include "golang/unsafe/unsafe.h"

namespace golang::runtime
{
    namespace rec
    {
        using namespace mocklib::rec;
    }

    gocpp::string gogetenv(gocpp::string key)
    {
        auto env = environ();
        if(env == nullptr)
        {
            go_throw("getenv before env init"_s);
        }
        for(auto [gocpp_ignored, s] : env)
        {
            if(len(s) > len(key) && s[len(key)] == '=' && envKeyEqual(s.make_slice(0, len(key)), key))
            {
                return s.make_slice(len(key) + 1);
            }
        }
        return ""_s;
    }

    // envKeyEqual reports whether a == b, with ASCII-only case insensitivity
    // on Windows. The two strings must have the same length.
    bool envKeyEqual(gocpp::string a, gocpp::string b)
    {
        if(GOOS == "windows"_s)
        {
            for(auto i = 0; i < len(a); i++)
            {
                auto [ca, cb] = std::tuple{a[i], b[i]};
                if(ca == cb || lowerASCII(ca) == lowerASCII(cb))
                {
                    continue;
                }
                return false;
            }
            return true;
        }
        return a == b;
    }

    unsigned char lowerASCII(unsigned char c)
    {
        if('A' <= c && c <= 'Z')
        {
            return c + ('a' - 'A');
        }
        return c;
    }

    gocpp::unsafe_pointer _cgo_setenv;
    gocpp::unsafe_pointer _cgo_unsetenv;
    // Update the C environment if cgo is loaded.
    void setenv_c(gocpp::string k, gocpp::string v)
    {
        if(_cgo_setenv == nullptr)
        {
            return;
        }
        auto arg = gocpp::array<gocpp::unsafe_pointer, 2> {cstring(k), cstring(v)};
        asmcgocall(_cgo_setenv, gocpp::unsafe_pointer(& arg));
    }

    // Update the C environment if cgo is loaded.
    void unsetenv_c(gocpp::string k)
    {
        if(_cgo_unsetenv == nullptr)
        {
            return;
        }
        auto arg = gocpp::array<gocpp::unsafe_pointer, 1> {cstring(k)};
        asmcgocall(_cgo_unsetenv, gocpp::unsafe_pointer(& arg));
    }

    gocpp::unsafe_pointer cstring(gocpp::string s)
    {
        auto p = gocpp::make(gocpp::Tag<gocpp::slice<unsigned char>>(), len(s) + 1);
        copy(p, s);
        return gocpp::unsafe_pointer(& p[0]);
    }

}

